<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Virtual Machine -- Zixuan Li</title>
  
  <!-- Bootstrap Core CSS -->
  <!-- 6/15/2018: Updated to the latest version of Bootstrap (4.1.1) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

  <!-- Custom Fonts -->
  <script src="https://use.fontawesome.com/4dfd1d7bab.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
  rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic'
  rel='stylesheet' type='text/css'>

  <!-- Plugin CSS -->
  <link href="../css/magnific-popup.css" rel="stylesheet">

  <!-- Theme CSS -->
  <link href="../css/creative.min_proj.css" rel="stylesheet">
  
  <!-- Index CSS -->
  <link href="../css/index.css" rel="stylesheet">
  
  <!-- Google Analytics Tracking Tag. Track how people access my site and such. -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-68657454-1', 'auto');
    ga('send', 'pageview');
  </script>
  
  <link rel="stylesheet" href="../css/prism.css"/>
</head>
  
<body>
<script src="https://lizirene.github.io/js/prism.js"></script>
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">

      <!-- Updated with latest Creative -->
      <a class="navbar-brand js-scroll-trigger" href="../">Home</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" 
              data-toggle="collapse" data-target="#navbarResponsive" 
              aria-controls="navbarResponsive" aria-expanded="false" 
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="#description">Description</a>
          </li>
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="#demo">Demo</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!--  Intro Section -->
  <header class="masthead text-center text-dark bg-white d-flex">
    <div class="container my-auto">
      <div class="row">
        <div class="col-lg-10 mx-auto">
          <h1 class="text-uppercase">
            <strong>Virtual Machine</strong>
          </h1>
          <hr>
        </div>
        <div class="col-lg-12 mx-auto">
          <img class="img-fluid" overflow=hidden width="100%" height="auto" src="../img/portfolio/thumbnails/Virtual_Machine.jpg" alt="">
        </div>
        <br>
        <div class="col-lg-8 mx-auto">
          <p class="mb-5 min-padding-top">
           This is a virtual machine for the imaginary ITP-11 computer system with the Turtle Processing
          UnitTM. This advanced system features fifteen 32-bit registers, 1 KB of stack space, and 3-bit color
          graphics.         
          </p>
          <p class="text-italic mb-5 min-padding-top">
            A detailed implemented project coded in C++ which can work together with <a href="ProCC_Compiler.html">ProCC Compiler</a>
          </p>
        </div>
      </div>
    </div>
  </header>
  
   <!--  Description Section -->
  <section class="min-padding-top text-center text-dark bg-light", id="description">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-10 mx-auto">
          <h3 class="text-uppercase">Description</h3>
          <hr>
        </div>
        <div class="col-lg-8 mx-auto min-padding-top">
          <h4 class="text-uppercase">What is a compiler? </h4>
          <p class="text-italic mb-5">
            "In computing, a virtual machine is an emulation of a computer system. 
            Virtual machines are based on computer architectures and provide functionality of a physical computer. 
            Their implementations may involve specialized hardware, software, or a combination.
            -- Wikipedia" 
          </p>
          <p class="text-italic min-padding-top mb-5">
            For this project, I implemented <strong>Registers/Flags</strong>, represented the <strong>stack</strong>, added a <a href="https://www.partow.net/programming/bitmap/index.html"><strong>Turtle Processing Unit</strong></a>
            and supported <strong>exceptions</strong>.
          </p>
        </div>
      </div>
    </div>
  </section>
  
     <!--  Demo Section -->
  <section class="min-padding-top text-center text-dark bg-white", id="demo">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-10 mx-auto">
          <h3 class="text-uppercase">Features and Demo</h3>
          <hr>
        </div>
                
<!--         First generating the AST -->
        <div class="col-lg-8 mx-auto min-padding-top">
           <h4 class="text-uppercase">First Step </h4>
          <p>
            I familiarized myself with basic operations and implemented the ParseStr template metaprogram.
          </p>
          <div class="row mb-5" style="text-align: center">
            <div style="width:100%;height:300px;overflow:scroll;margin:10px">
              <pre>
                <code class="language-cpp">
          push r0
          push r0
          push r0
          push r0
          push r0
          push r0
          push r0
          movi r1,5
          storei 1,r1
          movi r1,0
          storei 0,r1
          movi r1,100
          storei 2,r1
          movi r1,110
          movi r2,105
          mov tx,r1
          mov ty,r2
          pendown 
          loadi r1,0
          loadi r2,1
          cmplt r1,r2
          movi r1,37
          jnt r1
          loadi r1,0
          movi r2,1
          add r1,r1,r2
          mov tc,r1
          loadi r1,2
          fwd r1
          movi r1,144
          add tr,tr,r1
          loadi r1,0
          inc r1
          storei 0,r1
          movi r1,19
          jmp r1
          penup 
          movi r1,0
          back r1
          exit 
                </code>
              </pre>
            </div>
            <div style="width: 100%"><p>input file</p></div>
            <div style="width:100%;height:300px;overflow:scroll;margin:10px">
              <pre>
                <code class="language-cpp">
                  //ParseStr template metaprogram
                template <typename T>
                std::tuple<T> ParseElem(const std::string& elem)
                {}
                //specific
                template <>
                inline std::tuple<int> ParseElem<int>(const std::string& elem){
                    return std::make_tuple(std::stoi(elem));
                }
                template <>
                inline std::tuple<std::string> ParseElem<std::string>(const std::string& elem){
                    return std::make_tuple(elem);
                }
                template <>
                inline std::tuple<double> ParseElem<double>(const std::string& elem){
                    return std::make_tuple(std::stod(elem));
                }

                template <typename... Args>
                std::tuple<Args...> ParseStr(std::vector<std::string>& paramV);

                template <typename T, typename... Args>
                std::tuple<T, Args...> ParseStrHelper(std::vector<std::string>& paramV)
                {
                    std::string elem = paramV.back();
                    paramV.pop_back();
                    return std::tuple_cat(ParseElem<T>(elem),ParseStr<Args...>(paramV));
                }

                template <typename... Args>
                std::tuple<Args...> ParseStr(std::vector<std::string>& paramV){
                    return ParseStrHelper<Args...>(paramV);
                }

                //base case
                template <>
                inline std::tuple<> ParseStr<>(std::vector<std::string>& paramV){
                    return std::make_tuple();
                }
                </code>
              </pre>
            </div>
            <div style="width:100%"><p>parser for low level language(snippet)</p></div>
          </div>
        </div>
<!--         next generating nodes -->
        <div class="col-lg-8 mx-auto min-padding-top">
           <h4 class="text-uppercase">Next </h4>
          <p>
            I added the code for each operation and finished up the machine, including the stack, Turtle Processing Unit and exceptions.
          </p>
          <div class="row mb-5" style="text-align: center">
            <div style="margin:10px;height:300px;width:100%;overflow:scroll">
              <pre>
                <code class="language-cpp">
                  void Mul::Execute(Machine& machine)
                {
                    string reg1 = std::get<0>(mParameters), reg2 = std::get<1>(mParameters), reg3 = std::get<2>(mParameters);
                    if(reg1 == "sc"){
                        throw NonFatalException(10);
                    }
                    else if(reg1 == "r0"){
                        throw NonFatalException(11);
                    }
                    
                    int val1 = machine.getRegister(reg2), val2 = machine.getRegister(reg3);
                    if(reg1 == "tc" && (val1 * val2 < 0 || val1 * val2 > 7)){
                        throw NonFatalException(14); //set invalid color exception
                    }
                    machine.setRegister(reg1, val1 * val2);
                    
                    //underflow/overflow exception
                    if(static_cast<int64_t>(val1) > INT32_MAX || static_cast<int64_t>(val2) > INT32_MAX
                       || static_cast<int64_t>(val1) * static_cast<int64_t>(val2) > INT32_MAX){
                        throw NonFatalException(12);
                    }
                    if(static_cast<int64_t>(val1) < INT32_MIN || static_cast<int64_t>(val2) < INT32_MIN
                       || static_cast<int64_t>(val1) * static_cast<int64_t>(val2) < INT32_MIN){
                        throw NonFatalException(13);
                    }
                }

                void Div::Execute(Machine& machine)
                {
                    string reg1 = std::get<0>(mParameters), reg2 = std::get<1>(mParameters), reg3 = std::get<2>(mParameters);
                    if(reg1 == "sc"){
                        throw NonFatalException(10);
                    }
                    else if(reg1 == "r0"){
                        throw NonFatalException(11);
                    }
                    if(machine.getRegister(reg3) == 0){
                        throw FatalException(102); //divide by 0 exception
                    }
                    machine.setRegister(reg1, machine.getRegister(reg2) / machine.getRegister(reg3));
                }
                </code>
              </pre>
            </div>
            <div style="width:100%"><p>translate each operation(snippet)</p></div>
            <div style="width:100%;height:300px;overflow:scroll;margin:10px">
              <pre>
                <code class="language-cpp">
                  void Machine::setRegister(std::string str, int reg)
                  {
                      registers[str] = reg;
                  }

                  int Machine::getRegister(std::string str)
                  {
                      return registers[str];
                  }

                  void Machine::setFlag(std::string str, bool flag)
                  {
                      flags[str] = flag;
                  }

                  bool Machine::getFlag(std::string str)
                  {
                      return flags[str];
                  }

                  void Machine::fwd(int reg1)
                  {
                      int tx = registers["tx"], ty = registers["ty"];
                      float angle = registers["tr"] * 0.0174533f;
                      int endx = tx + static_cast<int>(std::cos(angle) * reg1);
                      int endy = ty + static_cast<int>(std::sin(angle) * reg1);
                      //if pendown, draw a line
                      if(flags["pen"]){
                          if(registers["tc"] < 0 || registers["tc"] > 7){
                              throw NonFatalException(14);    //invalid color
                          }
                          std::vector<unsigned char> color = colors[registers["tc"]];
                          drawer.pen_color(color[0], color[1], color[2]);
                          drawer.line_segment(tx, ty, endx, endy);
                      }
                      //update tx, ty
                      registers["tx"] = endx;
                      registers["ty"] = endy;
                  }
                </code>
              </pre>
            </div>
            <div style="width:100%"><p>finish up machine and stack(snippet)</p></div>
          </div>
        </div>
        
      </div>
    </div>
  </section>
  <br>
  <!--  THIS IS THE FOOTER - displays a copyright notice and
          that Bootstrap powers this web page. -->
    <div class="container bg-light min-padding-top">
      <p class="text-center text-muted text-small mb-1">
        Zixuan Li &copy; 2020. All rights reserved.
        Powered by <a href="http://www.getbootstrap.com/" class="text-blue">Bootstrap</a>.
      </p>
      <p class="text-center text-muted text-small">
        Theme based on the
        <a href="http://startbootstrap.com/template-overviews/creative/" class="text-blue">Creative Bootstrap Theme</a>
        by <a href="http://startbootstrap.com/" class="text-blue">Start Bootstrap</a>.
      </p>
    </div>

    <!-- Updated jQuery, added Popper.js, and updated Bootstrap JS to 4.1.1 -->
    <!-- Also pulling in the Bootstrap 4 update from Start Bootstrap too
         https://github.com/BlackrockDigital/startbootstrap-creative  -->

    <!-- jQuery 3.3.1 -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>

    <!-- Bootstrap 4.1 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

    <!-- Plugin & Theme JavaScript (With Bootstrap 4 Update) -->
    <script src="https://lizirene.github.io/js/jquery.easing.min.js"></script>
    <script src="https://lizirene.github.io/js/scrollreveal.min.js"></script>
    <script src="https://lizirene.github.io/js/jquery.magnific-popup.min.js"></script>
    <script src="https://lizirene.github.io/js/creative.min.js"></script>

  </body>
</html>

